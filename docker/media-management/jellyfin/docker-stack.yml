# Docker Swarm Stack f√ºr Jellyfin
# Deploy mit: docker stack deploy -c docker-stack.yml media

version: '3.8'

services:
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    env_file: jellyfin.env
    volumes:
      - jellyfin-library:/config
      - jellyfin-tvseries:/data/tvshows
      - jellyfin-movies:/data/movies
    dns:
      - 1.1.1.1
      - 8.8.8.8
    networks:
      - proxy
    ports:
      - target: 8096
        published: 8096
        protocol: tcp
        mode: host
      - target: 8920
        published: 8920
        protocol: tcp
        mode: host
      - target: 7359
        published: 7359
        protocol: udp
        mode: host
      - target: 1900
        published: 1900
        protocol: udp
        mode: host
    labels:
      - "traefik.docker.network=proxy"
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.${DOMAIN}`)"
      - "traefik.http.routers.jellyfin.tls=true"
      - "traefik.http.routers.jellyfin.tls.certresolver=http_resolver"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
      - "traefik.http.routers.jellyfin.middlewares=default@file,admin-whitelist@file"
      - "traefik.http.services.jellyfin.loadbalancer.sticky.cookie.httpOnly=true"
      - "traefik.http.services.jellyfin.loadbalancer.sticky.cookie.secure=true"
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: always

networks:
  proxy:
    external: true

volumes:
  jellyfin-library:
    driver: local
  jellyfin-tvseries:
    driver: local
  jellyfin-movies:
    driver: local

